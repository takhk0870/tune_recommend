# The Session を利用したおすすめチューン提示機能

## 概要

[The Session](https://thesession.org/)のユーザーが公開しているチューンブック（お気に入りの曲リスト）のデータを元にして、お気に入りの曲を入れるとおすすめの曲を推薦してくれるプログラムです。

このシステムは、大きく分けて2つの機能で構成されています。

1.  **データ収集機能 (`build_db.py`)**: The Sessionからユーザーと曲のデータを収集し、ローカルにSQLiteデータベースを構築します。
2.  **レコメンド機能 (`recommender.py`)**: 構築したデータベースを元に、指定したユーザーID（あなたのユーザーID）に対して最適な曲を推薦します。

## 主な機能

- **チューンブックデータ収集**: 登録されているユーザーのチューンブックを収集して、網羅的なデータベースを構築します。非常に大きいデータ収集を行うため、中断・再開が可能になっています。スクリプトはデータベース内の最後のユーザーIDを記憶し、その続きから収集を再開する仕組みです。
- **レコメンド機能**:
    - **協調フィルタリング**: あなたとブックマークの傾向が似ている上位10人のユーザーを探し出します。
    - **重複スコア**: 類似ユーザーの中で、特に多くの人が共通してブックマークしている人気の曲を優先して推薦します。
    - **総ブックマーク数**: 重複スコアが同じ場合は、データベース全体のブックマーク総数を元に、より一般的な人気曲を上位に表示します。
- **表示形式**:
    - 推薦結果を**リズム別**（Reel, Jig, Polkaなど）に分類して表示します。
    - Reel, Jig, Polka, Hornpipeを優先的に表示し、残りをアルファベット順で表示しています。
    - リズムごとに表示する曲の数を、実行時に指定できます。

## 動作環境

- Python 3.x

### 必要なライブラリ

```
requests
tqdm
```

## インストール

1.  このリポジトリをクローンまたはダウンロードします。
2.  必要なライブラリをインストールします。

    ```
    pip install -r requirements.txt
    ```

## 使い方

### ステップ1: データベースの構築（データ収集）

まず、推薦の元となるデータを集めるために`build_db.py`を実行します。

```
python build_db.py
```

- **初回実行時**: ユーザーID 1からデータ収集を開始します。
- **2回目以降の実行時**: データベースに保存されている最後のユーザーIDの続きから、自動的に収集を再開します。
- **停止**: `Ctrl + C`でいつでも安全に中断できます。
- **自動停止**: 一定数を超えた後、ユーザーのチューンブックが見つからない状態が20回連続で続くと、自動的に停止します。

**注意**: この処理は非常に時間がかかります。完了までに数時間〜数日かかる場合があります。1000ユーザー程度の規模で行ってもよいですが、全てのユーザーの情報を取り込む場合は少しずつ実行して、データベースを育てていくことをお勧めします。

### ステップ2: The Sessionのユーザー登録 & チューンブック作成

ステップ3で使う、あなたのチューンブックを作成してください。The Sessionのサイトでは、チューンのページに**ADD TO TUNEBOOK**というボタンがあります。そのボタンを押すことで曲をチューンブックに入れることができます。終わったら、**Your profile**のところのURL（`https://thesession.org/members/〇〇`）から、あなたのユーザーIDを取得してください。

### ステップ3: おすすめ曲の表示（推薦）

データベースとチューンブックができたら、`recommender.py`を使っておすすめの曲を表示します。

#### 基本的な使い方

```
python recommender.py <ユーザーID>
```

**例**: ユーザーIDが**1**の人へのおすすめを表示（各リズム上位5曲）
```
python recommender.py 1
```

#### 表示曲数を指定する場合

各リズムごとに表示する曲の数を指定できます。

**例**: ユーザーIDが**1**の人へのおすすめを、各リズム上位**10曲**ずつ表示
```
python recommender.py 1 10
```

### （任意）データベースの確認

`debug_user.py`を使うと、収集したデータベースの状態を確認できます。

**例**: データベースの状態と、ユーザーID**1**の人のブックマーク情報を確認
```
python debug_user.py thesession.db 1
```

## プロジェクト構成

-   `build_db.py`: データ収集を実行するスクリプト。
-   `recommender.py`: 推薦を実行するメインスクリプト。
-   `thesession.db`: 収集したデータが保存されるSQLiteデータベースファイル。
-   `debug_user.py`: データベースの状態を確認するためのスクリプト（build_db.pyの実行により生成）。
-   `requirements.txt`: 必要なPythonライブラリのリスト。
